@using PagedList.Mvc
@model _22DH114699_LTW.Models.ViewModel.ProductSearchVM

@{
    ViewBag.Title = "Danh Sách Sản Phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid py-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <h2 class="m-0">Danh Sách Sản Phẩm</h2>
        <div class="d-flex gap-2">
            @Html.ActionLink("➕ Thêm sản phẩm", "Create", null, new { @class = "btn btn-primary" })
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @using (Html.BeginForm("Index", "Products", FormMethod.Get, new { @class = "row gy-2 gx-2 align-items-center mb-3" }))
    {
        <div class="form-group search container">
            @Html.TextBoxFor(m => m.SearchTerm, new
            {
                @class = "form-control",
                placeholder = "Nhập tên/mô tả"
            })
            @Html.TextBoxFor(m => m.MinPrice, new
            {
                @class = "form-control",
                placeholder = "Nhập giá tối thiểu",
                type = "number",
                step = "1",
                min = "0"
            })
            @Html.TextBoxFor(m => m.MaxPrice, new
            {
                @class = "form-control",
                placeholder = "Nhập giá tối đa",
                type = "number",
                step = "1",
                min = "0"
            })
            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
        </div>
        <div class="form-group order-container">
            Sắp xếp theo
            @Html.ActionLink(
                                    "Tên tăng dần",
                                    "Index",
                                    "Products",
                                    new
                                    {
                                        sortOrder = "name_asc",
                                        SearchTerm = Model?.SearchTerm,
                                        MinPrice = Model?.MinPrice,
                                        MaxPrice = Model?.MaxPrice
                                    },
                                    null
                                )
            @Html.ActionLink(
                        "Tên giảm dần",
                        "Index",
                        "Products",
                        new
                        {
                            sortOrder = "name_desc",
                            SearchTerm = Model?.SearchTerm,
                            MinPrice = Model?.MinPrice,
                            MaxPrice = Model?.MaxPrice
                        },
                        null
                    )
            @Html.ActionLink(
                   "Giá tăng dần",
                   "Index",
                   "Products",
                   new
                   {
                       sortOrder = "price_asc",
                       SearchTerm = Model?.SearchTerm,
                       MinPrice = Model?.MinPrice,
                       MaxPrice = Model?.MaxPrice
                   },
                   null
               )
            @Html.ActionLink(
                   "Giá giảm dần",
                   "Index",
                   "Products",
                   new
                   {
                       sortOrder = "price_desc",
                       SearchTerm = Model?.SearchTerm,
                       MinPrice = Model?.MinPrice,
                       MaxPrice = Model?.MaxPrice
                   },
                   null
               )
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Hình</th>
                            <th>@Html.DisplayNameFor(m => m.Products.First().ProductName)</th>
                            <th class="w-50">@Html.DisplayNameFor(m => m.Products.First().ProductDescription)</th>
                            <th class="text-end">@Html.DisplayNameFor(m => m.Products.First().ProductPrice)</th>
                            <th>@Html.DisplayNameFor(m => m.Products.First().Category.CategoryName)</th>
                            <th class="text-end">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model?.Products != null && Model.Products.Any())
                        {
                            foreach (var item in Model.Products)
                            {
                                <tr>
                                    <td style="width:80px;">
                                        @{
                                            string imgPath;
                                            if (string.IsNullOrEmpty(item.ProductImage))
                                            {
                                                imgPath = Url.Content("~/Images/no-image.png");
                                            }
                                            else if (item.ProductImage.StartsWith("http://") || item.ProductImage.StartsWith("https://"))
                                            {
                                                imgPath = item.ProductImage;
                                            }
                                            else if (item.ProductImage.StartsWith("~") || item.ProductImage.StartsWith("/"))
                                            {
                                                imgPath = Url.Content(item.ProductImage);
                                            }
                                            else
                                            {
                                                imgPath = Url.Content("~/Images/" + item.ProductImage);
                                            }
                                        }
                                        <img src="@imgPath"
                                             alt="@item.ProductName"
                                             class="img-thumbnail"
                                             style="width:64px;height:64px;object-fit:cover;border-radius:.5rem;" />
                                    </td>
                                    <td class="fw-semibold">@Html.DisplayFor(_ => item.ProductName)</td>
                                    <td class="text-body-secondary">
                                        @{
                                            var desc = item.ProductDescription ?? "";
                                            var clipped = desc.Length > 140 ? (desc.Substring(0, 140) + "…") : desc;
                                        }
                                        @clipped
                                    </td>
                                    <td class="text-end">
                                        @String.Format("{0:N0}", item.ProductPrice) đ
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@Html.DisplayFor(_ => item.Category.CategoryName)</span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" role="group">
                                            @Html.ActionLink("Sửa", "Edit", new { id = item.ProductID }, new { @class = "btn btn-outline-primary" })
                                            @Html.ActionLink("Xem", "Details", new { id = item.ProductID }, new { @class = "btn btn-outline-secondary" })
                                            @Html.ActionLink("Xóa", "Delete", new { id = item.ProductID }, new { @class = "btn btn-outline-danger" })
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6">
                                    <div class="text-center text-body-secondary py-4">
                                        Chưa có sản phẩm nào phù hợp.
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer bg-white d-flex flex-wrap gap-2 justify-content-between align-items-center">
            <small class="text-body-secondary">
                Trang @(Model?.Products?.PageNumber ?? 1) / @(Model?.Products?.PageCount ?? 1) 
                - Hiển thị @(Model?.Products?.Count ?? 0) / @(Model?.Products?.TotalItemCount ?? 0) sản phẩm
            </small>
            
            @if (Model?.Products != null && Model.Products.PageCount > 1)
            {
                <div>
                    @Html.PagedListPager(Model.Products, 
                        page => Url.Action("Index", new { 
                            page, 
                            sortOrder = Request.QueryString["sortOrder"],
                            SearchTerm = Model.SearchTerm, 
                            MinPrice = Model.MinPrice, 
                            MaxPrice = Model.MaxPrice 
                        }),
                        new PagedList.Mvc.PagedListRenderOptions
                        {
                            DisplayLinkToFirstPage = PagedList.Mvc.PagedListDisplayMode.Always,
                            DisplayLinkToLastPage = PagedList.Mvc.PagedListDisplayMode.Always,
                            DisplayLinkToPreviousPage = PagedList.Mvc.PagedListDisplayMode.Always,
                            DisplayLinkToNextPage = PagedList.Mvc.PagedListDisplayMode.Always,
                            MaximumPageNumbersToDisplay = 5,
                            LinkToFirstPageFormat = "<",
                            LinkToPreviousPageFormat = "<",
                            LinkToNextPageFormat = ">",
                            LinkToLastPageFormat = ">",
                            UlElementClasses = new[] { "pagination", "pagination-sm", "mb-0" },
                            LiElementClasses = new[] { "page-item" }
                        })
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .pagination {
            margin: 0;
        }
        .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        .page-link {
            color: #0d6efd;
            padding: 0.375rem 0.75rem;
            text-decoration: none;
            background-color: #fff;
            border: 1px solid #dee2e6;
        }
        .page-link:hover {
            color: #0a58ca;
            background-color: #e9ecef;
            border-color: #dee2e6;
        }
    </style>
}